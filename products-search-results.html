<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>The Viridian Network</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" type="text/css" href="css/cards.css">
  <link rel="stylesheet" type="text/css" href="css/score-bar.css">
</head>

<body>
  <header>
    <div id="header-top" class="three-full-widths">
      <div id="normal-header">
        <div>
          <img src="images/viridian_logo_bw_offwhite.svg" alt="Viridian Logo">
          <span id="brand-big">The Viridian Network</span>
          <span id="brand-small">Viridian</span>
        </div>
        <nav>
          <ul>
            <li>
              <a title="Search" href="#" onclick="document.getElementById('header-top').classList.add('slided-to-left-1-of-2');">
                <img src="icons/md-search.svg" alt="Search"><span id="search-span">Search</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      <div id="search-header">
        <a title="Back" href="#" onclick="document.getElementById('header-top').classList.remove('slided-to-left-1-of-2');">
          <img src="icons/md-arrow-back.svg" alt="Back">
        </a>
        <nav>
          <ul>
            <li>
              <a title="Search by Barcode" href="#">
                <img src="icons/barcode.svg" alt="Search by Barcode"><span id="barcode-search-span">Search by Barcode</span>
              </a>
            </li>
            <li>
              <a title="Search by Product Name" href="#" onclick="document.getElementById('header-top').classList.remove('slided-to-left-1-of-2'); document.getElementById('header-top').classList.add('slided-to-left-2-of-2');">
                <img src="icons/font.svg" alt="Search by Product Name"><span id="product-name-search-span">Search by Product Name</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      <div id="search-textinput-header">
        <a title="Back" href="#" onclick="document.getElementById('header-top').classList.remove('slided-to-left-2-of-2'); document.getElementById('header-top').classList.add('slided-to-left-1-of-2');">
          <img src="icons/md-arrow-back.svg" alt="Back">
        </a>
        <div><input type="text" name="product-name" id="product-name"></div>
        <a title="Submit" href="products-search-results.html">
          <img src="icons/md-send.svg" alt="Submit">
        </a>
      </div>
    </div>
    <ul id="header-tabs">
      <li>
        <a title="Products" class="active-tab" href="products.html"><img src="icons/md-cube.svg" alt="Products"><span id="products-span">Products</span></a>
      </li>
      <li>
        <a title="Labels" href="labels.html"><img src="icons/award.svg" alt="Labels"><span id="labels-span">Labels</span></a>
      </li>
      <li>
        <a title="Companies" href="companies.html"><img src="icons/building.svg" alt="Companies"><span id="companies-span">Companies</span></a>
      </li>
    </ul>
  </header>
  <div id="main-content">
    <section id="cards">
      <article v-for="prod in products">
        <div class="card-img">
          <a v-bind:href="prod.url">
            <img v-bind:style="prod.imgStyle">
          </a>
        </div>
        <div class="card-header">
          <h2 v-bind:title="prod.name">
            <a v-bind:href="prod.url">{{ prod.name }}</a>
          </h2>
        </div>
        <div class="card-quant" v-bind:title="prod.quant">{{ prod.quant }}</div>
        <div class="card-desc" v-bind:title="prod.desc">
          <a v-bind:href="prod.url">
            {{ prod.desc }}
          </a>
        </div>
        <div class="card-score">
          <div class="card-score-text">
            <p>Score: </p>
          </div>
          <div class="card-score-blob noselect" v-on:click="placeHovercard(prod.id, 'click')" v-on:touchend="placeHovercard(prod.id, 'click')" v-on:mouseover="placeHovercard(prod.id, 'mouseover')" v-on:mouseout="placeHovercard(prod.id, 'mouseout')">
            <div v-bind:id="'blob-'+prod.id" class="score-bar-indicator" v-bind:style="prod.color">
              <span>{{ prod.score }}</span>
            </div>
          </div>
          <div class="card-score-bar card-score-bar-regular">
            <div class="score-bar">
              <div class="score-bar-tick score-bar-tick-minusseventyfive"></div>
              <div class="score-bar-tick score-bar-tick-minusfifty"></div>
              <div class="score-bar-tick score-bar-tick-minustwentyfive"></div>
              <div class="score-bar-tick score-bar-tick-zero"></div>
              <div class="score-bar-tick score-bar-tick-twentyfive"></div>
              <div class="score-bar-tick score-bar-tick-fifty"></div>
              <div class="score-bar-tick score-bar-tick-seventyfive"></div>
              <div class="score-bar-indicator-gray" v-bind:style="prod.position"></div>
            </div>
            <div class="score-bar-label-row">
              <span class="score-bar-label score-bar-label-min">-100</span>
              <span class="score-bar-label score-bar-label-zero">0</span>
              <span class="score-bar-label score-bar-label-max">100</span>
            </div>
          </div>
        </div>
        <div class="card-price" v-bind:title="prod.priceCurr">{{ prod.priceCurr }}</div>
        <div class="card-score-bar card-score-bar-tiny-screens">
          <div class="score-bar">
            <div class="score-bar-tick score-bar-tick-minusseventyfive"></div>
            <div class="score-bar-tick score-bar-tick-minusfifty"></div>
            <div class="score-bar-tick score-bar-tick-minustwentyfive"></div>
            <div class="score-bar-tick score-bar-tick-zero"></div>
            <div class="score-bar-tick score-bar-tick-twentyfive"></div>
            <div class="score-bar-tick score-bar-tick-fifty"></div>
            <div class="score-bar-tick score-bar-tick-seventyfive"></div>
            <div class="score-bar-indicator-gray" v-bind:style="prod.position"></div>
          </div>
          <div class="score-bar-label-row">
            <span class="score-bar-label score-bar-label-min">-100</span>
            <span class="score-bar-label score-bar-label-zero">0</span>
            <span class="score-bar-label score-bar-label-max">100</span>
          </div>
        </div>
        <!-- Hovercard with details on the product score: -->
        <div v-bind:id="'hovercard-'+prod.id" class="hovercard" style="display: none;" data-permanent=false>
          <div class="hovercard-row">
            <div>Environment:</div>
            <div class="score-bar-indicator score-bar-indicator-small" v-bind:style="prod.detailedColors.environment">
              <span>{{ prod.detailedScore.environment }}</span>
            </div>
          </div>
          <div class="hovercard-row">
            <div>Climate:</div>
            <div class="score-bar-indicator score-bar-indicator-small" v-bind:style="prod.detailedColors.climate">
              <span>{{ prod.detailedScore.climate }}</span>
            </div>
          </div>
          <div class="hovercard-row">
            <div>Society:</div>
            <div class="score-bar-indicator score-bar-indicator-small" v-bind:style="prod.detailedColors.society">
              <span>{{ prod.detailedScore.society }}</span>
            </div>
          </div>
          <div class="hovercard-row">
            <div>Health:</div>
            <div class="score-bar-indicator score-bar-indicator-small" v-bind:style="prod.detailedColors.health">
              <span>{{ prod.detailedScore.health }}</span>
            </div>
          </div>
          <div class="hovercard-row">
            <div>Animal welfare:</div>
            <div class="score-bar-indicator score-bar-indicator-small" v-bind:style="prod.detailedColors.animalWelfare">
              <span>{{ prod.detailedScore.animalWelfare }}</span>
            </div>
          </div>
          <div class="hovercard-row">
            <div>Economy:</div>
            <div class="score-bar-indicator score-bar-indicator-small" v-bind:style="prod.detailedColors.economy">
              <span>{{ prod.detailedScore.economy }}</span>
            </div>
          </div>
        </div>
      </article>
    </section>
    <!-- 
    <aside>
      <h4>Settings</h4>
      <label for="time">Time</label>
      <input type="range" name="time" id="time" list="data-dates">
      <datalist id="data-dates">
        <option value="2018-01-01" label="01 Jan 2018"></option>
        <option value="2018-04-01"></option>
        <option value="2018-07-01"></option>
        <option value="2018-10-01"></option>
        <option value="2019-01-01" label="01 Jan 2019"></option>
        <option value="2019-04-01"></option>
        <option value="2019-07-01"></option>
        <option value="2019-09-15" label="Today"></option>
      </datalist>
      <label for="lang">Language</label>
      <select name="lang" id="lang">
        <option value="en">English</option>
        <option value="de">Deutsch</option>
      </select>
    </aside>
     -->
  </div>
  <footer>
    <p>Copyright 2019 The Viridian Project</p>
  </footer>
  <!-- development version, includes helpful console warnings -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
  <script src="js/vue.js"></script>
  <!-- <script src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons.js"></script> -->
  <script src="data/products.js"></script>
  <script src="score-color.js"></script>
  <script src="data/preferences.js"></script>
  <script>
    /* Build the products object based on preferences */
    var products = [];
    for (let product of productSearchResults) {
      /* Fetch the preferred locale */
      let prefLocale = {};
      for (let lang of prefLanguages) {
        if (lang in product.locales) {
          prefLocale = product.locales[lang];
          break;
        }
      }
      // if no preferred locale is not present, fall back to first existing locale
      if (Object.keys(prefLocale).length == 0 && Object.keys(product.locales).length > 0) { // is there easier way to access object length?
        prefLocale = Object.values(product.locales)[0];
      }
      // if still undefined, create default empty locale
      prefLocale = setDefaultIfEmpty(prefLocale);
      let score = calcTotalScore(product.score, preferences.scoreWeighting);
      let color = calcScoreColor(score);
      let detailedColors = {};
      let detailedPositions = {};
      for (let key in product.score) {
        let c = calcScoreColor(product.score[key]);
        detailedColors[key] = 'background-color: rgb(' + c[0] + ', ' + c[1] + ', ' + c[2] + ');';
        detailedPositions[key] = 'left: ' + (product.score[key] + 100) / 2 + '%';
      }
      products.push({
        id: product.id,
        name: prefLocale.name,
        desc: prefLocale.description,
        quant: prefLocale.quantities[0],
        price: prefLocale.price,
        curr: prefLocale.currency,
        priceCurr: concatPriceAndCurrency(prefLocale.price, prefLocale.currency, preferences['preferredLang']),
        imgStyle: 'background-image: url("' + prefLocale.imageUrls[0] + '");',
        score: score,
        color: 'background-color: rgb(' + color[0] + ', ' + color[1] + ', ' + color[2] + ');',
        position: 'left: ' + (score + 100) / 2 + '%',
        detailedScore: product.score,
        detailedColors: detailedColors,
        detailedPositions: detailedPositions,
        url: 'product.html#' + product.id
      });
    }
    var maxPriceLength = 0;
    for (let p of products) {
      if (p.priceCurr.length > maxPriceLength) {
        maxPriceLength = p.priceCurr.length;
      }
    }
    if (maxPriceLength > 9) {
      document.getElementById('cards').classList.add('price-10-chars');
    } else if (maxPriceLength > 8) {
      document.getElementById('cards').classList.add('price-9-chars');
    } else if (maxPriceLength > 7) {
      document.getElementById('cards').classList.add('price-8-chars');
    }

    var product_cards = new Vue({
      el: '#cards',
      data: {
        products: products
      },
      methods: {
        placeHovercard(id, what) {
          let hovercard = document.getElementById('hovercard-' + id);
          let permanent = hovercard.getAttribute('data-permanent');
          let show = false;
          let hide = false;
          if (permanent == "false" && what == 'mouseover') show = true;
          else if (permanent == "false" && what == 'mouseout') hide = true;
          else if (permanent == "false" && what == 'click') {
            hovercard.setAttribute('data-permanent', true);
            show = true;
          } else if (permanent == "true" && what == 'click') {
            hovercard.setAttribute('data-permanent', false);
            show = false;
          }
          if (show) {
            let blob = document.getElementById('blob-' + id);
            let rect = blob.getBoundingClientRect();
            let windowWidth = (window.innerWidth || document.documentElement.clientWidth ||
              document.body.clientWidth);
            let windowHeight = (window.innerHeight || document.documentElement.clientHeight ||
              document.body.clientHeight);
            let leftOffset = blob.clientWidth;
            let above = false;
            if (windowHeight - rect.top < 300) {
              above = true;
            }
            if (!above) {
              hovercard.classList.remove('hovercard-above');
              hovercard.style.top = (rect.bottom + 10) + 'px';
              hovercard.style.bottom = null;
            } else {
              hovercard.classList.add('hovercard-above');
              hovercard.style.top = null;
              hovercard.style.bottom = (windowHeight - rect.top + 10) + 'px';
            }
            hovercard.style.left = (rect.left - leftOffset) + 'px';
            hovercard.style.display = 'block';
          } else if (hide) {
            hovercard.style.display = 'none';
          }
        }
      }
    })
  </script>
</body>

</html>